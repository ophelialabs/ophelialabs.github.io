<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Networks - Interactive Visualization</title>
    
    <!-- Visualization Library CDN Links -->
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Cesium.js (3D Globe) -->
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.104/Widgets/widgets.css" rel="stylesheet">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.104/Cesium.js"></script>
    
    <!-- Babylon.js (3D Engine) -->
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    
    <!-- Mapbox GL -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
            background-color: #0f172a;
            border-radius: 8px;
        }

        .header {
            margin-bottom: 24px;
        }

        .header h1 {
            font-size: 32px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 8px;
        }

        .header p {
            color: #9ca3af;
        }

        .content-wrapper {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
        }

        #map {
            width: 100%;
            height: 600px;
            border-radius: 8px;
            border: 1px solid #334155;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
            max-height: 600px;
            overflow-y: auto;
        }

        .panel {
            background-color: #1e293b;
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #334155;
        }

        .panel h3 {
            font-size: 16px;
            font-weight: 700;
            color: #ffffff;
            margin-bottom: 12px;
        }

        .stat-item {
            margin-bottom: 12px;
        }

        .stat-label {
            color: #9ca3af;
            font-size: 12px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-top: 4px;
        }

        .stat-value.green {
            color: #4ade80;
        }

        .stat-value.yellow {
            color: #facc15;
        }

        .stat-value.blue {
            color: #60a5fa;
        }

        .node-list {
            max-height: 280px;
            overflow-y: auto;
        }

        .node-item {
            width: 100%;
            text-align: left;
            padding: 8px;
            border-radius: 4px;
            border: none;
            background-color: #0f172a;
            cursor: pointer;
            transition: background-color 0.2s;
            color: #d1d5db;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .node-item:hover {
            background-color: #334155;
        }

        .node-item.active {
            background-color: #2563eb;
            color: white;
        }

        .node-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #334155;
        }

        .node-details h4 {
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .detail-item {
            margin-bottom: 4px;
            font-size: 12px;
            color: #d1d5db;
        }

        .detail-label {
            color: #9ca3af;
        }

        .info-window {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 12px;
            border-radius: 4px;
            border: 1px solid #334155;
        }

        .info-window h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #ffffff;
        }

        .info-window p {
            margin: 4px 0;
            font-size: 12px;
        }

        @media (max-width: 1024px) {
            .content-wrapper {
                grid-template-columns: 1fr;
            }

            #map {
                height: 500px;
            }

            .sidebar {
                max-height: auto;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            #map {
                height: 400px;
            }

            .sidebar {
                grid-template-columns: 1fr;
            }
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        button:hover {
            opacity: 0.9;
        }

        button:active {
            transform: scale(0.98);
        }

        /* Leaflet popup customization */
        .leaflet-popup-content-wrapper {
            background-color: #1e293b !important;
            border: 1px solid #334155 !important;
            border-radius: 4px !important;
        }

        .leaflet-popup-tip {
            background-color: #1e293b !important;
            border-top: 1px solid #334155 !important;
        }

        .leaflet-popup-content {
            margin: 0 !important;
        }

        .custom-popup .info-window {
            background-color: transparent;
            border: none;
            padding: 0;
        }

        .custom-popup .info-window h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #ffffff;
        }

        .custom-popup .info-window p {
            margin: 4px 0;
            font-size: 12px;
            color: #e2e8f0;
        }

        .custom-popup .detail-label {
            color: #9ca3af;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Quantum Networks</h1>
            <p>Interactive network visualization with switchable libraries and views</p>
            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                <div style="display: flex; gap: 8px; align-items: center;">
                    <span style="color: #9ca3af; font-size: 12px; font-weight: 500;">Library:</span>
                    <button id="libLeafletBtn" class="lib-btn" onclick="switchLibrary('leaflet')" style="padding: 8px 12px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 12px;">üìç Leaflet</button>
                    <button id="libCesiumBtn" class="lib-btn" onclick="switchLibrary('cesium')" style="padding: 8px 12px; background-color: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 12px;">üåê Cesium</button>
                    <button id="libThreeBtn" class="lib-btn" onclick="switchLibrary('three')" style="padding: 8px 12px; background-color: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 12px;">üé® Three.js</button>
                    <button id="libMapboxBtn" class="lib-btn" onclick="switchLibrary('mapbox')" style="padding: 8px 12px; background-color: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; font-size: 12px;">üó∫Ô∏è Mapbox</button>
                </div>
                <div style="display: flex; gap: 8px; align-items: center; border-left: 1px solid #334155; padding-left: 12px;">
                    <span style="color: #9ca3af; font-size: 12px; font-weight: 500;">View:</span>
                    <button id="view2dBtn" style="padding: 8px 16px; background-color: #2563eb; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: background-color 0.2s;" onclick="switchTo2DMap()">üìã 2D</button>
                    <button id="view3dBtn" style="padding: 8px 16px; background-color: #64748b; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; transition: background-color 0.2s;" onclick="switchTo3DGlobe()">üåê 3D</button>
                </div>
            </div>
        </div>

        <div class="content-wrapper">
            <div id="map"></div>
            <div class="sidebar">
                <div class="panel">
                    <h3>Network Stats</h3>
                    <div class="stat-item">
                        <p class="stat-label">Total Nodes</p>
                        <p class="stat-value green" id="totalNodes">0</p>
                    </div>
                    <div class="stat-item">
                        <p class="stat-label">Active</p>
                        <p class="stat-value green" id="activeCount">0</p>
                    </div>
                    <div class="stat-item">
                        <p class="stat-label">Connecting</p>
                        <p class="stat-value yellow" id="connectingCount">0</p>
                    </div>
                    <div class="stat-item">
                        <p class="stat-label">Total Capacity</p>
                        <p class="stat-value blue" id="totalCapacity">0 Q</p>
                    </div>
                </div>

                <div class="panel">
                    <h3>Nodes</h3>
                    <div class="node-list" id="nodesList"></div>
                </div>

                <div class="panel" id="detailsPanel" style="display: none;">
                    <h3>Node Details</h3>
                    <div id="nodeDetails"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        const CONFIG = {
            DEFAULT_LIBRARY: 'leaflet', // Options: 'leaflet', 'cesium', 'three', 'mapbox'
            DEFAULT_VIEW: '2d', // Options: '2d', '3d'
        };

        const NETWORK_NODES = [
  // North America
  {
    id: 1,
    name: 'Chattanooga Hub',
    latitude: 35.0456,
    longitude: -85.2672,
    status: 'üü¢ Active',
    capacity: 250,
    region: 'North America'
  },
  {
    id: 2,
    name: 'Oak Ridge Node',
    latitude: 35.9181,
    longitude: -84.2679,
    status: 'üü¢ Active',
    capacity: 180,
    region: 'North America'
  },
  {
    id: 3,
    name: 'Atlanta Center',
    latitude: 33.7490,
    longitude: -84.3880,
    status: 'üü¢ Active',
    capacity: 300,
    region: 'North America'
  },
  {
    id: 4,
    name: 'Washington Node',
    latitude: 38.9072,
    longitude: -77.0369,
    status: 'üü° Connecting',
    capacity: 120,
    region: 'North America'
  },
  {
    id: 5,
    name: 'Boston Labs',
    latitude: 42.3601,
    longitude: -71.0589,
    status: 'üü¢ Active',
    capacity: 220,
    region: 'North America'
  },
  {
    id: 6,
    name: 'Toronto Quantum Center',
    latitude: 43.6629,
    longitude: -79.3957,
    status: 'üü¢ Active',
    capacity: 190,
    region: 'North America'
  },
  {
    id: 7,
    name: 'San Francisco Node',
    latitude: 37.7749,
    longitude: -122.4194,
    status: 'üü¢ Active',
    capacity: 280,
    region: 'North America'
  },
  {
    id: 8,
    name: 'Los Angeles Terminal',
    latitude: 34.0522,
    longitude: -118.2437,
    status: 'üü¢ Active',
    capacity: 260,
    region: 'North America'
  },
  // Europe
  {
    id: 9,
    name: 'London Hub',
    latitude: 51.5074,
    longitude: -0.1278,
    status: 'üü¢ Active',
    capacity: 310,
    region: 'Europe'
  },
  {
    id: 10,
    name: 'Berlin Facility',
    latitude: 52.5200,
    longitude: 13.4050,
    status: 'üü¢ Active',
    capacity: 240,
    region: 'Europe'
  },
  {
    id: 11,
    name: 'Paris Research Lab',
    latitude: 48.8566,
    longitude: 2.3522,
    status: 'üü¢ Active',
    capacity: 270,
    region: 'Europe'
  },
  {
    id: 12,
    name: 'Amsterdam Center',
    latitude: 52.3676,
    longitude: 4.9041,
    status: 'üü° Connecting',
    capacity: 150,
    region: 'Europe'
  },
  {
    id: 13,
    name: 'Stockholm Node',
    latitude: 59.3293,
    longitude: 18.0686,
    status: 'üü¢ Active',
    capacity: 200,
    region: 'Europe'
  },
  {
    id: 14,
    name: 'Geneva Hub',
    latitude: 46.2044,
    longitude: 6.1432,
    status: 'üü¢ Active',
    capacity: 230,
    region: 'Europe'
  },
  // Asia
  {
    id: 15,
    name: 'Tokyo Quantum Center',
    latitude: 35.6762,
    longitude: 139.6503,
    status: 'üü¢ Active',
    capacity: 320,
    region: 'Asia'
  },
  {
    id: 16,
    name: 'Singapore Node',
    latitude: 1.3521,
    longitude: 103.8198,
    status: 'üü¢ Active',
    capacity: 290,
    region: 'Asia'
  },
  {
    id: 17,
    name: 'Shanghai Facility',
    latitude: 31.2304,
    longitude: 121.4737,
    status: 'üü¢ Active',
    capacity: 300,
    region: 'Asia'
  },
  {
    id: 18,
    name: 'Hong Kong Hub',
    latitude: 22.3193,
    longitude: 114.1694,
    status: 'üü° Connecting',
    capacity: 170,
    region: 'Asia'
  },
  {
    id: 19,
    name: 'Mumbai Terminal',
    latitude: 19.0760,
    longitude: 72.8777,
    status: 'üü¢ Active',
    capacity: 210,
    region: 'Asia'
  },
  {
    id: 20,
    name: 'Seoul Research Institute',
    latitude: 37.5665,
    longitude: 126.9780,
    status: 'üü¢ Active',
    capacity: 250,
    region: 'Asia'
  },
  // Australia
  {
    id: 21,
    name: 'Sydney Center',
    latitude: -33.8688,
    longitude: 151.2093,
    status: 'üü¢ Active',
    capacity: 220,
    region: 'Australia'
  },
  {
    id: 22,
    name: 'Melbourne Node',
    latitude: -37.8136,
    longitude: 144.9631,
    status: 'üü° Connecting',
    capacity: 160,
    region: 'Australia'
  },
  // South America
  {
    id: 23,
    name: 'S√£o Paulo Hub',
    latitude: -23.5505,
    longitude: -46.6333,
    status: 'üü¢ Active',
    capacity: 200,
    region: 'South America'
  },
  {
    id: 24,
    name: 'Buenos Aires Node',
    latitude: -34.6037,
    longitude: -58.3816,
    status: 'üü° Connecting',
    capacity: 140,
    region: 'South America'
  },
];

        // ============================================================================
        // VISUALIZATION LIBRARY ADAPTER INTERFACE
        // ============================================================================
        class VisualizationAdapter {
            async init(container, nodes) { throw new Error('Not implemented'); }
            loadMarkers(nodes, onMarkerClick) { throw new Error('Not implemented'); }
            panToNode(node) { throw new Error('Not implemented'); }
            switchView(view) { throw new Error('Not implemented'); }
            dispose() { throw new Error('Not implemented'); }
        }

        // ============================================================================
        // LEAFLET ADAPTER
        // ============================================================================
        class LeafletAdapter extends VisualizationAdapter {
            constructor() {
                super();
                this.map = null;
                this.markers = {};
            }

            async init(container, nodes) {
                const mapElement = document.getElementById(container);
                if (!mapElement) {
                    console.error(`Map container '${container}' not found`);
                    return;
                }
                
                this.map = L.map(container).setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    maxZoom: 19
                }).addTo(this.map);
                
                // Force map to recalculate size
                this.map.invalidateSize();
            }

            loadMarkers(nodes, onMarkerClick) {
                Object.values(this.markers).forEach(marker => this.map.removeLayer(marker));
                this.markers = {};

                nodes.forEach(node => {
                    const isActive = node.status.includes('Active');
                    const color = isActive ? '#10b981' : '#f59e0b';

                    const markerHTML = `
                        <div style="
                            width: 16px;
                            height: 16px;
                            background-color: ${color};
                            border: 2px solid white;
                            border-radius: 50%;
                            box-shadow: 0 0 0 3px ${color}40;
                        "></div>
                    `;

                    const customIcon = L.divIcon({
                        html: markerHTML,
                        className: 'custom-marker',
                        iconSize: [24, 24],
                        iconAnchor: [12, 12],
                        popupAnchor: [0, -12]
                    });

                    const marker = L.marker([node.latitude, node.longitude], { icon: customIcon }).addTo(this.map);
                    marker.bindPopup(createPopupContent(node), { className: 'custom-popup', maxWidth: 250, minWidth: 200 });
                    marker.on('click', () => onMarkerClick(node));

                    this.markers[node.id] = marker;
                });
            }

            panToNode(node) {
                this.map.setView([node.latitude, node.longitude], 4);
                this.markers[node.id].openPopup();
            }

            switchView(view) {
                if (view === '2d') {
                    this.map.setZoom(2);
                } else {
                    this.map.setZoom(3);
                }
            }

            dispose() {
                if (this.map) {
                    this.map.remove();
                    this.map = null;
                }
            }
        }

        // ============================================================================
        // CESIUM ADAPTER (3D Globe)
        // ============================================================================
        class CesiumAdapter extends VisualizationAdapter {
            constructor() {
                super();
                this.viewer = null;
                this.entities = {};
            }

            async init(container) {
                try {
                    // Disable Ion token error (use without authentication)
                    Cesium.Ion.defaultAccessToken = '';
                    
                    const element = document.getElementById(container);
                    if (!element) {
                        console.error(`Container ${container} not found`);
                        return;
                    }

                    // Ensure element is empty and properly styled
                    element.innerHTML = '';
                    element.style.position = 'relative';
                    element.style.width = '100%';
                    element.style.height = '600px';
                    element.style.margin = '0';
                    element.style.padding = '0';
                    element.style.overflow = 'hidden';
                    element.style.backgroundColor = '#000000';

                    // Create minimal Cesium viewer configuration
                    this.viewer = new Cesium.Viewer(container, {
                        animation: false,
                        baseLayerPicker: false,
                        fullscreenButton: false,
                        geocoder: false,
                        homeButton: false,
                        infoBox: false,
                        navigationHelpButton: false,
                        sceneModePicker: false,
                        selectionIndicator: false,
                        timeline: false,
                        vrButton: false
                    });
                    
                    // Configure scene
                    this.viewer.scene.globe.enableLighting = false;
                    this.viewer.scene.backgroundColor = Cesium.Color.BLACK;
                    
                    // Set initial view
                    this.viewer.camera.setView({
                        destination: Cesium.Cartesian3.fromDegrees(0, 20, 15000000),
                        orientation: {
                            heading: Cesium.Math.toRadians(0),
                            pitch: Cesium.Math.toRadians(-45),
                            roll: Cesium.Math.toRadians(0)
                        }
                    });
                } catch (error) {
                    console.error('Cesium initialization error:', error);
                }
            }

            loadMarkers(nodes, onMarkerClick) {
                try {
                    if (!this.viewer) return;
                    
                    Object.values(this.entities).forEach(entity => {
                        if (this.viewer.entities.contains(entity)) {
                            this.viewer.entities.remove(entity);
                        }
                    });
                    this.entities = {};

                    nodes.forEach(node => {
                        const isActive = node.status.includes('Active');
                        const color = isActive ? Cesium.Color.LIME : Cesium.Color.YELLOW;

                        const entity = this.viewer.entities.add({
                            position: Cesium.Cartesian3.fromDegrees(node.longitude, node.latitude, 0),
                            point: {
                                pixelSize: 10,
                                color: color,
                                outlineColor: Cesium.Color.WHITE,
                                outlineWidth: 2,
                                heightReference: Cesium.HeightReference.NONE,
                            },
                            properties: { node: node }
                        });

                        entity.node = node;
                        this.entities[node.id] = entity;
                    });
                } catch (error) {
                    console.error('Error loading markers:', error);
                }
            }

            panToNode(node) {
                try {
                    if (!this.viewer || !this.entities[node.id]) return;
                    
                    this.viewer.flyTo(this.entities[node.id], {
                        duration: 1,
                        offset: new Cesium.HeadingPitchRange(
                            Cesium.Math.toRadians(0),
                            Cesium.Math.toRadians(-45),
                            5000000
                        )
                    });
                } catch (error) {
                    console.error('Error panning to node:', error);
                }
            }

            switchView(view) {
                try {
                    if (!this.viewer) return;
                    
                    if (view === '2d') {
                        this.viewer.scene.morphToMapView(1);
                    } else {
                        this.viewer.scene.morphTo3D(1);
                    }
                } catch (error) {
                    console.error('Error switching view:', error);
                }
            }

            dispose() {
                try {
                    if (this.viewer) {
                        this.viewer.destroy();
                        this.viewer = null;
                    }
                } catch (error) {
                    console.error('Error disposing Cesium viewer:', error);
                }
            }
        }

        // ============================================================================
        // MAPBOX ADAPTER
        // ============================================================================
        class MapboxAdapter extends VisualizationAdapter {
            constructor() {
                super();
                this.map = null;
                this.markers = {};
            }

            async init(container) {
                // Mapbox token - using a public token that works without authentication
                mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycW1qN3UycXd0bDEifQ.rJcFIG214AriISLbB6B6MA';
                
                const element = document.getElementById(container);
                element.innerHTML = '';
                
                return new Promise((resolve) => {
                    this.map = new mapboxgl.Map({
                        container: container,
                        style: 'mapbox://styles/mapbox/dark-v11',
                        center: [0, 20],
                        zoom: 2
                    });
                    
                    this.map.on('load', () => {
                        resolve();
                    });
                    
                    this.map.on('error', (e) => {
                        console.error('Mapbox error:', e);
                        resolve();
                    });
                });
            }

            loadMarkers(nodes, onMarkerClick) {
                // Remove existing markers
                Object.values(this.markers).forEach(marker => marker.remove());
                this.markers = {};

                nodes.forEach(node => {
                    const isActive = node.status.includes('Active');
                    const color = isActive ? '#10b981' : '#f59e0b';

                    const el = document.createElement('div');
                    el.style.width = '20px';
                    el.style.height = '20px';
                    el.style.backgroundColor = color;
                    el.style.border = '2px solid white';
                    el.style.borderRadius = '50%';
                    el.style.cursor = 'pointer';

                    const marker = new mapboxgl.Marker(el)
                        .setLngLat([node.longitude, node.latitude])
                        .setPopup(new mapboxgl.Popup({ offset: 25 }).setHTML(createPopupContent(node)))
                        .addTo(this.map);

                    el.addEventListener('click', () => onMarkerClick(node));
                    this.markers[node.id] = marker;
                });
            }

            panToNode(node) {
                this.map.flyTo({
                    center: [node.longitude, node.latitude],
                    zoom: 4,
                    duration: 1000
                });
                this.markers[node.id].togglePopup();
            }

            switchView(view) {
                if (view === '2d') {
                    this.map.setPitch(0);
                    this.map.setBearing(0);
                    this.map.setZoom(2);
                } else {
                    this.map.setPitch(60);
                    this.map.setBearing(45);
                    this.map.setZoom(3);
                }
            }

            dispose() {
                if (this.map) {
                    this.map.remove();
                    this.map = null;
                }
            }
        }

        // ============================================================================
        // THREE.JS ADAPTER (Custom 3D Visualization)
        // ============================================================================
        class ThreeJSAdapter extends VisualizationAdapter {
            constructor() {
                super();
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.sphereGeometry = null;
                this.markers = {};
                this.raycaster = new THREE.Raycaster();
                this.mouse = new THREE.Vector2();
            }

            async init(container) {
                const element = document.getElementById(container);
                const width = element.clientWidth;
                const height = element.clientHeight;

                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x000000);
                this.camera = new THREE.PerspectiveCamera(75, width / height, 0.1, 10000);
                this.camera.position.z = 2.5;

                this.renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                this.renderer.setSize(width, height);
                this.renderer.setClearColor(0x000000, 1);
                element.innerHTML = '';
                element.appendChild(this.renderer.domElement);

                // Create sphere (Earth) with ocean blue color
                const geometry = new THREE.SphereGeometry(1, 64, 64);
                const material = new THREE.MeshPhongMaterial({ 
                    color: 0x1a4d7a,
                    shininess: 30,
                    emissive: 0x0a1f2e
                });
                const sphere = new THREE.Mesh(geometry, material);
                this.scene.add(sphere);

                // Add wireframe for visual effect
                const wireGeometry = new THREE.SphereGeometry(1.01, 32, 32);
                const wireMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0x334155,
                    wireframe: true,
                    transparent: true,
                    opacity: 0.2
                });
                const wireframe = new THREE.Mesh(wireGeometry, wireMaterial);
                this.scene.add(wireframe);

                // Lighting
                const light1 = new THREE.DirectionalLight(0xffffff, 1);
                light1.position.set(5, 3, 5);
                this.scene.add(light1);
                const light2 = new THREE.DirectionalLight(0xffffff, 0.6);
                light2.position.set(-5, -3, -5);
                this.scene.add(light2);
                this.scene.add(new THREE.AmbientLight(0xffffff, 0.6));

                // Handle mouse interaction
                document.getElementById(container).addEventListener('click', (event) => {
                    const rect = this.renderer.domElement.getBoundingClientRect();
                    this.mouse.x = ((event.clientX - rect.left) / width) * 2 - 1;
                    this.mouse.y = -((event.clientY - rect.top) / height) * 2 + 1;

                    this.raycaster.setFromCamera(this.mouse, this.camera);
                    const intersects = this.raycaster.intersectObjects(Object.values(this.markers));

                    if (intersects.length > 0) {
                        const node = intersects[0].object.userData.node;
                        this.onMarkerClick(node);
                    }
                });

                // Start animation loop
                this.animate();
            }

            loadMarkers(nodes, onMarkerClick) {
                Object.values(this.markers).forEach(marker => this.scene.remove(marker));
                this.markers = {};
                this.onMarkerClick = onMarkerClick;

                nodes.forEach(node => {
                    const isActive = node.status.includes('Active');
                    const color = isActive ? 0x10b981 : 0xf59e0b;

                    const geometry = new THREE.SphereGeometry(0.02, 16, 16);
                    const material = new THREE.MeshPhongMaterial({ color: color, emissive: color, emissiveIntensity: 0.5 });
                    const marker = new THREE.Mesh(geometry, material);

                    // Position on sphere surface
                    const lat = node.latitude * (Math.PI / 180);
                    const lon = node.longitude * (Math.PI / 180);
                    marker.position.x = Math.cos(lat) * Math.cos(lon);
                    marker.position.y = Math.sin(lat);
                    marker.position.z = Math.cos(lat) * Math.sin(lon);

                    marker.userData.node = node;
                    this.scene.add(marker);
                    this.markers[node.id] = marker;
                });
            }

            panToNode(node) {
                const lat = node.latitude * (Math.PI / 180);
                const lon = node.longitude * (Math.PI / 180);
                const target = new THREE.Vector3(
                    Math.cos(lat) * Math.cos(lon) * 2.5,
                    Math.sin(lat) * 2.5,
                    Math.cos(lat) * Math.sin(lon) * 2.5
                );
                this.camera.position.lerp(target, 0.1);
            }

            switchView(view) {
                if (view === '2d') {
                    this.camera.position.z = 2.5;
                } else {
                    this.camera.position.z = 3;
                }
            }

            animate = () => {
                requestAnimationFrame(this.animate);
                if (this.scene && this.renderer) {
                    this.renderer.render(this.scene, this.camera);
                }
            }

            dispose() {
                if (this.renderer) {
                    this.renderer.dispose();
                    document.getElementById('map').innerHTML = '';
                }
            }
        }

        // ============================================================================
        // APPLICATION STATE & MANAGEMENT
        // ============================================================================
        let visualizationAdapter = null;
        let currentLibrary = null;
        let currentView = '2d';
        let focusedNode = null;

        // DOM Elements
        const totalNodesEl = document.getElementById('totalNodes');
        const activeCountEl = document.getElementById('activeCount');
        const connectingCountEl = document.getElementById('connectingCount');
        const totalCapacityEl = document.getElementById('totalCapacity');
        const nodesListEl = document.getElementById('nodesList');
        const nodeDetailsEl = document.getElementById('nodeDetails');
        const detailsPanel = document.getElementById('detailsPanel');

        // ============================================================================
        // CORE FUNCTIONS
        // ============================================================================
        
        function createPopupContent(node) {
            return `
                <div class="info-window">
                    <h4>${node.name}</h4>
                    <p><span class="detail-label">Status:</span> ${node.status}</p>
                    <p><span class="detail-label">Region:</span> ${node.region}</p>
                    <p><span class="detail-label">Capacity:</span> ${node.capacity} Q</p>
                    <p><span class="detail-label">Lat/Lon:</span> ${node.latitude.toFixed(4)}, ${node.longitude.toFixed(4)}</p>
                </div>
            `;
        }

        async function switchLibrary(libraryName) {
            if (currentLibrary === libraryName) return;
            
            // Update button state immediately
            currentLibrary = libraryName;
            updateLibraryButtons();
            
            // Dispose current adapter
            if (visualizationAdapter) {
                visualizationAdapter.dispose();
            }

            // Create new adapter
            switch (libraryName) {
                case 'leaflet':
                    visualizationAdapter = new LeafletAdapter();
                    break;
                case 'cesium':
                    visualizationAdapter = new CesiumAdapter();
                    break;
                case 'three':
                    visualizationAdapter = new ThreeJSAdapter();
                    break;
                case 'mapbox':
                    visualizationAdapter = new MapboxAdapter();
                    break;
                default:
                    console.error('Unknown library:', libraryName);
                    return;
            }

            // Clear and reinitialize map container
            const mapContainer = document.getElementById('map');
            mapContainer.innerHTML = '';

            // Initialize new adapter
            await visualizationAdapter.init('map', NETWORK_NODES);
            visualizationAdapter.loadMarkers(NETWORK_NODES, setFocusedNode);
            visualizationAdapter.switchView(currentView);
        }

        function setFocusedNode(node) {
            focusedNode = node;
            updateUI();
        }

        function initializeNodesList() {
            nodesListEl.innerHTML = NETWORK_NODES.map(node => `
                <button class="node-item ${focusedNode?.id === node.id ? 'active' : ''}" data-id="${node.id}">
                    <strong>${node.name}</strong><br>
                    <small>${node.region} ‚Ä¢ ${node.status}</small>
                </button>
            `).join('');

            document.querySelectorAll('.node-item').forEach(btn => {
                btn.addEventListener('click', () => {
                    const nodeId = parseInt(btn.getAttribute('data-id'));
                    const node = NETWORK_NODES.find(n => n.id === nodeId);
                    setFocusedNode(node);
                    visualizationAdapter.panToNode(node);
                });
            });
        }

        function updateUI() {
            initializeNodesList();
            updateStats();
            updateNodeDetails();
        }

        function updateStats() {
            totalNodesEl.textContent = NETWORK_NODES.length;
            activeCountEl.textContent = NETWORK_NODES.filter(n => n.status.includes('Active')).length;
            connectingCountEl.textContent = NETWORK_NODES.filter(n => n.status.includes('Connecting')).length;
            totalCapacityEl.textContent = NETWORK_NODES.reduce((sum, n) => sum + n.capacity, 0) + ' Q';
        }

        function updateNodeDetails() {
            if (focusedNode) {
                detailsPanel.style.display = 'block';
                nodeDetailsEl.innerHTML = `
                    <div class="node-details">
                        <div class="detail-item">
                            <span class="detail-label">Name:</span> ${focusedNode.name}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status:</span> ${focusedNode.status}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Region:</span> ${focusedNode.region}
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Capacity:</span> ${focusedNode.capacity} Q
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Lat/Lon:</span> ${focusedNode.latitude.toFixed(4)}, ${focusedNode.longitude.toFixed(4)}
                        </div>
                    </div>
                `;
            } else {
                detailsPanel.style.display = 'none';
                nodeDetailsEl.innerHTML = '';
            }
        }

        function switchTo2DMap() {
            if (currentView === '2d') return;
            currentView = '2d';
            updateViewButtons();
            visualizationAdapter.switchView('2d');
        }

        function switchTo3DGlobe() {
            if (currentView === '3d') return;
            currentView = '3d';
            updateViewButtons();
            visualizationAdapter.switchView('3d');
        }

        function updateViewButtons() {
            const btn2d = document.getElementById('view2dBtn');
            const btn3d = document.getElementById('view3dBtn');
            
            if (currentView === '2d') {
                btn2d.style.backgroundColor = '#2563eb';
                btn3d.style.backgroundColor = '#64748b';
            } else {
                btn2d.style.backgroundColor = '#64748b';
                btn3d.style.backgroundColor = '#2563eb';
            }
        }

        function updateLibraryButtons() {
            const buttons = {
                leaflet: document.getElementById('libLeafletBtn'),
                cesium: document.getElementById('libCesiumBtn'),
                three: document.getElementById('libThreeBtn'),
                mapbox: document.getElementById('libMapboxBtn'),
            };

            Object.keys(buttons).forEach(lib => {
                buttons[lib].style.backgroundColor = lib === currentLibrary ? '#2563eb' : '#64748b';
            });
        }

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        document.addEventListener('DOMContentLoaded', async () => {
            // Small delay to ensure DOM is fully rendered
            await new Promise(resolve => setTimeout(resolve, 50));
            
            try {
                await switchLibrary('leaflet');
                updateStats();
                initializeNodesList();
            } catch (error) {
                console.error('Failed to initialize map:', error);
            }
        });
    </script>
</body>
</html>